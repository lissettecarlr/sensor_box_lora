# LORAWAN传感器应用节点代码

#### 介绍
该套代码为传感器应用的专用代码，主要实现低功耗、传感器采集、周期上报的功能。淡化交互。

#### 硬件说明
##### 自研模组
MCU: STM32L151CBT6
RADIO: SX1278
晶振: 8M+32.768KHz
内部MCU与RADIO连线: SPI1(PA4/NSS、PA5/SCK、PA6/MISO、PA7/MOSI)   DIO(PB0/DIO2、PB1/DIO3、PB2/DIO1、PB10/DIO0、PB11/RST)

IIC接口:  PB6 ------> I2C1_SCL  PB7 ------> I2C1_SDA
注: 修改使用STMCUBE工具，将会更改msp.c中的引脚初始化. 

命令行交互: 串口1(PA9 TX,PA10 RX) 

#### 使用说明
下载固件后，连接串口输入lw_set进入配置模式，通过命令lw_id读出DEVEUI和APPKEY，平台进行注册,可以通过lw_cycle命令修改上报周期，默认20分钟。然后通过命令lw_start正式启动设备。
出厂设备分为三个阶段:
* 等待休眠阶段
该阶段发送在设备上电或者复位后，会进行一段时间的待机，时间长短和是否入过网有关，等待结束后会进入休眠或者正常运行阶段，在该阶段通过lw_set进入配置阶段
* 配置阶段
该阶段只有在 等待休眠阶段 接收到lw_set才会发生，该阶段没有超时，只有在接收到lw_start后才会退出。该阶段用于读取注册设备所需的deveui和appkey、配置上报周期、是否开启低功耗(该功能在调试阶段存在，正式版删除)。
* 运行阶段
当接收到lw_start后进入运行状态，进行入网，周期上报。如果入网成功，则下一次重启，在等待休眠阶段超时后直接接入运行阶段



#### 其他

模组的入网为OTAA+ABP方式，该方式是先使用OTAA入网，然后保存下行数据，当发生掉电等情况需要重新入网时，则根据之前保存的信息进行ABP入网。
该版本删去了lorawan的下行窗口，为了降低功耗


#### 数据格式
|上行格式|电压|光照|温度|湿度|
|---|---|---|---|
||2byte|2byte|2byte|2byte|

特制值:0XFFBB表示传感器丢失


#### 命令说明
* 获取节点基本信息

|命令|返回|
|---|---|
|lw_id||

* 正式启动设备

|命令|返回|
|---|---|
|lw_start||

* 清除入网信息

|命令|返回|
|---|---|
|lw_clear|[clear OK]|

* 保存信息
通常不需要使用，在修改完成后进行入网，入网成功将自动保存配置
|命令|返回|
|---|---|
|lw_save|[save OK]|

* 修改周期,单位s
自动保存仅仅发生在入网的时候，如果中途修改该周期，请用lw_save保存，防止掉电丢失
|命令|返回|
|---|---|
|lw_cycle 30|[cycle set :30]|

* 重启
|命令|返回|
|---|---|
|lw_rst||

* 时钟选择
|命令|说明|
|lw_lp on|使能低功耗模式，将使用RTC|
|lw_lp off|使能低功耗模式，将使用系统时钟|